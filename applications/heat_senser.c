/*
 * File      : heat_meter.c
 *
 * This file impliment the thread process senser data about heat meter.
 *
 * Change Logs:
 * Date           Author       Notes
 * 2015-4-22      Schumy       First version
 */

#include <rtthread.h>
#include <stdio.h>

#include "spi_tdc_gp21.h"
#include "board.h"

struct hm_print_data {
    rt_uint16_t x;
    rt_uint16_t y;
    const char* str;
};

#define TOF_DATA_BUF_LEN            (30)
static struct spi_tdc_gp21_tof_data tof_data[TOF_DATA_BUF_LEN];
#define TEMP_DATA_BUF_LEN           (5)
static struct spi_tdc_gp21_temp_scales temp_data[TEMP_DATA_BUF_LEN];

#define TOF_SLEEP_TIME_MS           (500)
#define TEMP_SLEEP_TIME_MS          (3000)

static rt_event_t cal_event;
#define TOF_DATA_FULL_EVENT         (1U<<0)
#define TEMP_DATA_FULL_EVENT        (1U<<1)

static rt_mutex_t tdc_lock;
static rt_mutex_t tof_lock;
static rt_mutex_t temp_lock;
#define LOCK_TACK_WAIT_TIME_MS      (500)

#define MS_TO_TICKS(ms)             ((ms)*RT_TICK_PER_SECOND/1000)

#define PT1000_MIN_TEMP             (-50)
#define PT1000_MAX_TEMP             (100)
const static float PT1000[][10] = {
    /*        0.0         0.1         0.2         0.3         0.4         0.5         0.6         0.7         0.8         0.9  */
    /*-49*/{807.033,    806.604,    806.239,    805.842,    805.445,    805.048,    804.651,    804.254,    803.857,    803.460},
    /*-48*/{811.003,    810.606,    810.209,    809.812,    809.415,    809.018,    808.621,    808.224,    807.827,    807.430},
    /*-47*/{814.970,    814.573,    814.177,    813.780,    813.383,    812.987,    812.590,    812.193,    811.796,    811.400},
    /*-46*/{818.937,    818.540,    818.144,    817.747,    817.350,    816.954,    816.557,    816.160,    815.763,    815.367},
    /*-45*/{822.902,    822.506,    822.109,    821.713,    821.316,    820.920,    820.523,    820.127,    819.730,    819.334},
    /*-44*/{826.865,    826.469,    826.072,    825.676,    825.280,    824.884,    824.487,    824.091,    823.695,    823.298},
    /*-43*/{830.828,    830.432,    830.035,    829.639,    829.243,    828.847,    828.450,    828.054,    827.658,    827.261},
    /*-42*/{834.789,    834.393,    833.997,    833.601,    833.205,    832.809,    832.412,    832.016,    831.620,    831.224},
    /*-41*/{838.748,    838.352,    837.956,    837.560,    837.164,    836.769,    836.373,    835.977,    835.581,    835.185},
    /*-40*/{842.707,    842.311,    841.915,    841.519,    841.123,    840.728,    840.332,    839.936,    839.540,    839.144},
    /*-39*/{846.664,    846.268,    845.873,    845.477,    845.081,    844.686,    844.290,    843.894,    843.498,    843.103},
    /*-38*/{850.619,    850.224,    849.828,    849.433,    849.037,    848.642,    848.246,    847.851,    847.455,    847.060},
    /*-37*/{854.573,    854.179,    853.783,    853.388,    852.992,    852.597,    852.201,    851.806,    851.410,    851.015},
    /*-36*/{858.526,    858.131,    857.735,    857.340,    856.945,    856.550,    856.154,    855.759,    855.364,    854.968},
    /*-35*/{862.478,    862.082,    861.688,    861.292,    860.897,    860.502,    860.107,    859.712,    859.316,    858.921},
    /*-34*/{866.428,    866.033,    865.638,    865.243,    864.848,    864.453,    864.058,    863.663,    863.268,    862.873},
    /*-33*/{870.377,    869.982,    869.587,    869.192,    868.797,    868.403,    868.008,    867.613,    867.218,    866.823},
    /*-32*/{874.325,    873.930,    873.535,    873.141,    872.746,    872.351,    871.956,    871.561,    871.166,    870.772},
    /*-31*/{878.272,    877.877,    877.483,    877.088,    876.693,    876.299,    875.904,    875.509,    875.114,    874.720},
    /*-30*/{882.217,    881.823,    881.428,    881.034,    880.639,    880.245,    879.850,    879.456,    879.061,    878.667},
    /*-29*/{886.161,    885.766,    885.372,    884.978,    884.583,    884.189,    883.795,    883.400,    883.006,    882.611},
    /*-28*/{890.103,    889.709,    889.315,    888.920,    888.526,    888.132,    887.738,    887.344,    886.949,    886.555},
    /*-27*/{894.044,    893.650,    893.256,    892.862,    892.468,    892.074,    891.679,    891.285,    890.891,    890.497},
    /*-26*/{897.985,    897.591,    897.197,    896.803,    896.409,    896.015,    895.620,    895.226,    894.832,    894.438},
    /*-25*/{901.923,    901.529,    901.135,    900.742,    900.348,    899.954,    899.560,    899.166,    898.773,    898.379},
    /*-24*/{905.861,    905.467,    905.073,    904.680,    904.286,    903.892,    903.498,    903.104,    902.711,    902.317},
    /*-23*/{909.798,    909.404,    909.011,    908.617,    908.223,    907.830,    907.436,    907.042,    906.648,    906.255},
    /*-22*/{913.733,    913.340,    912.946,    912.553,    912.159,    911.766,    911.372,    910.979,    910.585,    910.192},
    /*-21*/{917.666,    917.273,    916.879,    916.486,    916.093,    915.700,    915.306,    914.913,    914.520,    914.126},
    /*-20*/{921.599,    921.206,    920.812,    920.419,    920.026,    919.633,    919.239,    918.846,    918.453,    918.059},
    /*-19*/{925.531,    925.138,    924.745,    924.351,    923.958,    923.565,    923.172,    922.779,    922.385,    921.992},
    /*-18*/{929.460,    929.067,    928.674,    928.281,    927.888,    927.496,    927.103,    926.710,    926.317,    925.924},
    /*-17*/{933.390,    932.997,    932.604,    932.211,    931.818,    931.425,    931.032,    930.639,    930.246,    929.853},
    /*-16*/{937.317,    936.924,    936.532,    936.139,    935.746,    935.354,    934.961,    934.568,    934.175,    933.783},
    /*-15*/{941.244,    940.851,    940.459,    940.066,    939.673,    939.281,    938.888,    938.495,    938.102,    937.710},
    /*-14*/{945.170,    944.777,    944.385,    943.992,    943.600,    943.207,    942.814,    942.422,    942.029,    941.637},
    /*-13*/{949.094,    948.702,    948.309,    947.917,    947.524,    947.132,    946.740,    946.347,    945.955,    945.562},
    /*-12*/{953.016,    952.624,    952.232,    951.839,    951.447,    951.055,    950.663,    950.271,    949.878,    949.486},
    /*-11*/{956.938,    956.546,    956.154,    955.761,    955.369,    954.977,    954.585,    954.193,    953.800,    953.408},
    /*-10*/{960.859,    960.467,    960.075,    959.683,    959.291,    958.899,    958.506,    958.114,    957.722,    957.330},
    /*-9*/ {964.779,    964.387,    963.995,    963.603,    963.211,    962.819,    962.427,    962.035,    961.643,    961.251},
    /*-8*/ {968.697,    968.305,    967.913,    967.522,    967.130,    966.738,    966.346,    965.954,    965.563,    965.171},
    /*-7*/ {972.614,    972.222,    971.831,    971.439,    971.047,    970.656,    970.264,    969.872,    969.480,    969.089},
    /*-6*/ {976.529,    976.138,    975.746,    975.355,    974.963,    974.572,    974.180,    973.789,    973.397,    973.006},
    /*-5*/ {980.444,    980.053,    979.662,    979.270,    978.879,    978.487,    978.096,    977.704,    977.313,    976.921},
    /*-4*/ {984.358,    983.967,    983.575,    983.184,    982.793,    982.401,    982.010,    981.618,    981.227,    980.835},
    /*-3*/ {988.270,    987.879,    987.488,    987.096,    986.705,    986.314,    985.923,    985.532,    985.140,    984.749},
    /*-2*/ {992.181,    991.790,    991.399,    991.008,    990.617,    990.226,    989.834,    989.443,    989.052,    988.661},
    /*-1*/ {996.091,    995.700,    995.309,    994.918,    994.527,    994.136,    993.745,    993.354,    992.963,    992.572},
    /*0*/  {1000.000,   1000.391,   1000.782,   1001.172,   1001.563,   1001.954,   1002.345,   1002.736,   1003.126,   1003.517},
    /*1*/  {1003.908,   1004.298,   1004.689,   1005.080,   1005.470,   1005.861,   1006.252,   1006.642,   1007.033,   1007.424},
    /*2*/  {1007.814,   1008.205,   1008.595,   1008.986,   1009.377,   1009.767,   1010.158,   1010.548,   1010.939,   1011.320},
    /*3*/  {1011.720,   1012.110,   1012.501,   1012.891,   1013.282,   1013.672,   1014.060,   1014.453,   1014.843,   1015.230},
    /*4*/  {1015.624,   1016.014,   1016.405,   1016.795,   1017.185,   1017.576,   1017.966,   1018.356,   1018.747,   1019.130},
    /*5*/  {1019.527,   1019.917,   1020.308,   1020.698,   1021.088,   1021.478,   1021.868,   1022.259,   1022.649,   1023.030},
    /*6*/  {1023.429,   1023.819,   1024.209,   1024.599,   1024.989,   1025.380,   1025.770,   1026.160,   1026.550,   1026.940},
    /*7*/  {1027.330,   1027.720,   1028.110,   1028.500,   1028.890,   1029.280,   1029.670,   1030.060,   1030.450,   1030.840},
    /*8*/  {1031.229,   1031.619,   1032.009,   1032.399,   1032.789,   1033.179,   1033.569,   1033.958,   1034.348,   1034.738},
    /*9*/  {1035.128,   1035.518,   1035.907,   1036.297,   1036.687,   1037.077,   1037.466,   1037.856,   1038.246,   1038.636},
    /*10*/ {1039.025,   1039.415,   1039.805,   1040.194,   1040.584,   1040.973,   1041.363,   1041.753,   1042.142,   1042.530},
    /*11*/ {1042.921,   1043.311,   1043.701,   1044.090,   1044.480,   1044.869,   1045.250,   1045.648,   1046.038,   1046.427},
    /*12*/ {1046.816,   1047.206,   1047.595,   1047.985,   1048.374,   1048.764,   1049.153,   1049.542,   1049.932,   1050.321},
    /*13*/ {1050.710,   1051.099,   1051.489,   1051.878,   1052.268,   1052.657,   1053.040,   1053.435,   1053.825,   1054.210},
    /*14*/ {1054.603,   1054.992,   1055.381,   1055.771,   1056.160,   1056.549,   1056.930,   1057.327,   1057.716,   1058.105},
    /*15*/ {1058.495,   1058.884,   1059.273,   1059.662,   1060.051,   1060.440,   1060.829,   1061.218,   1061.607,   1061.996},
    /*16*/ {1062.385,   1062.774,   1063.163,   1063.552,   1063.941,   1064.330,   1064.719,   1065.108,   1065.496,   1065.885},
    /*17*/ {1066.274,   1066.663,   1067.052,   1067.441,   1067.830,   1068.218,   1068.607,   1068.996,   1069.385,   1069.774},
    /*18*/ {1070.162,   1070.551,   1070.940,   1071.328,   1071.717,   1072.106,   1072.495,   1072.883,   1073.272,   1073.661},
    /*19*/ {1074.049,   1074.438,   1074.826,   1075.215,   1075.604,   1075.992,   1076.381,   1076.769,   1077.158,   1077.546},
    /*20*/ {1077.935,   1078.324,   1078.712,   1079.101,   1079.489,   1079.877,   1080.266,   1080.654,   1081.043,   1081.430},
    /*21*/ {1081.820,   1082.208,   1082.596,   1082.985,   1083.373,   1083.762,   1084.150,   1084.538,   1084.926,   1085.310},
    /*22*/ {1085.703,   1086.091,   1086.480,   1086.868,   1087.256,   1087.644,   1088.033,   1088.421,   1088.809,   1089.197},
    /*23*/ {1089.585,   1089.974,   1090.362,   1090.750,   1091.138,   1091.526,   1091.914,   1092.302,   1092.690,   1093.078},
    /*24*/ {1093.467,   1093.855,   1094.243,   1094.631,   1095.019,   1095.407,   1095.795,   1096.183,   1096.571,   1096.959},
    /*25*/ {1097.347,   1097.734,   1098.122,   1098.510,   1098.898,   1099.286,   1099.670,   1100.062,   1100.450,   1100.838},
    /*26*/ {1101.225,   1101.613,   1102.001,   1102.389,   1102.777,   1103.164,   1103.550,   1103.940,   1104.328,   1104.710},
    /*27*/ {1105.103,   1105.491,   1105.879,   1106.266,   1106.654,   1107.042,   1107.429,   1107.817,   1108.204,   1108.590},
    /*28*/ {1108.980,   1109.367,   1109.755,   1110.142,   1110.530,   1110.917,   1111.305,   1111.693,   1112.080,   1112.468},
    /*29*/ {1112.855,   1113.242,   1113.630,   1114.017,   1114.405,   1114.792,   1115.180,   1115.567,   1115.954,   1116.342},
    /*30*/ {1116.729,   1117.117,   1117.504,   1117.891,   1118.279,   1118.666,   1119.053,   1119.441,   1119.828,   1120.215},
    /*31*/ {1120.602,   1120.990,   1121.377,   1121.764,   1122.151,   1122.538,   1122.920,   1123.313,   1123.700,   1124.087},
    /*32*/ {1124.474,   1124.861,   1125.248,   1125.636,   1126.023,   1126.410,   1126.797,   1127.184,   1127.571,   1127.958},
    /*33*/ {1128.345,   1128.732,   1129.119,   1130.127,   1129.893,   1130.280,   1130.667,   1131.054,   1131.441,   1131.820},
    /*34*/ {1132.215,   1132.602,   1132.988,   1133.375,   1133.762,   1134.149,   1134.536,   1134.923,   1135.309,   1135.690},
    /*35*/ {1136.083,   1136.470,   1136.857,   1137.243,   1137.630,   1138.017,   1138.404,   1138.790,   1139.177,   1139.564},
    /*36*/ {1139.950,   1140.337,   1140.724,   1141.110,   1141.497,   1141.884,   1142.270,   1142.657,   1143.043,   1143.430},
    /*37*/ {1143.817,   1144.203,   1144.590,   1144.976,   1145.363,   1145.749,   1146.136,   1146.522,   1146.909,   1147.295},
    /*38*/ {1147.681,   1148.068,   1148.454,   1148.841,   1149.227,   1149.614,   1150.000,   1150.386,   1150.773,   1151.159},
    /*39*/ {1151.545,   1151.932,   1152.318,   1152.704,   1153.091,   1153.477,   1153.860,   1154.249,   1154.636,   1155.020},
    /*40*/ {1155.408,   1155.794,   1156.180,   1156.567,   1156.953,   1157.339,   1157.725,   1158.111,   1158.497,   1158.883},
    /*41*/ {1159.270,   1159.656,   1160.042,   1160.428,   1160.814,   1161.200,   1161.586,   1161.972,   1162.358,   1162.744},
    /*42*/ {1163.130,   1163.516,   1163.902,   1164.288,   1164.674,   1165.060,   1165.446,   1165.831,   1166.217,   1166.600},
    /*43*/ {1166.989,   1167.375,   1167.761,   1168.147,   1168.532,   1168.918,   1169.304,   1169.690,   1170.076,   1170.460},
    /*44*/ {1170.847,   1171.233,   1171.619,   1172.004,   1172.390,   1172.776,   1173.161,   1173.547,   1173.933,   1174.318},
    /*45*/ {1174.704,   1175.090,   1175.475,   1175.861,   1176.247,   1176.632,   1177.018,   1177.403,   1177.789,   1178.174},
    /*46*/ {1178.560,   1178.945,   1179.331,   1179.716,   1180.102,   1180.487,   1180.873,   1181.258,   1181.644,   1182.029},
    /*47*/ {1182.414,   1182.800,   1183.185,   1183.571,   1183.956,   1184.341,   1184.727,   1185.112,   1185.597,   1185.883},
    /*48*/ {1186.268,   1186.653,   1187.038,   1187.424,   1187.809,   1188.194,   1188.579,   1188.965,   1189.350,   1189.735},
    /*49*/ {1190.120,   1190.505,   1190.890,   1191.276,   1191.661,   1192.046,   1192.431,   1192.816,   1193.201,   1193.586},
    /*50*/ {1193.971,   1194.356,   1194.741,   1195.126,   1195.511,   1195.896,   1196.281,   1196.666,   1197.051,   1197.436},
    /*51*/ {1197.821,   1198.206,   1198.591,   1198.976,   1199.361,   1199.746,   1200.131,   1200.516,   1200.900,   1201.285},
    /*52*/ {1201.670,   1202.055,   1202.440,   1202.824,   1203.209,   1203.594,   1203.979,   1204.364,   1204.748,   1205.133},
    /*53*/ {1205.518,   1205.902,   1206.287,   1206.672,   1207.056,   1207.441,   1207.826,   1208.210,   1208.595,   1208.980},
    /*54*/ {1209.364,   1209.749,   1210.133,   1210.518,   1210.902,   1211.287,   1211.670,   1212.056,   1212.441,   1212.825},
    /*55*/ {1213.210,   1213.594,   1213.978,   1214.363,   1214.747,   1215.120,   1215.516,   1215.901,   1216.285,   1216.669},
    /*56*/ {1217.054,   1217.438,   1217.822,   1218.207,   1218.591,   1218.975,   1219.360,   1219.744,   1220.128,   1220.513},
    /*57*/ {1220.897,   1221.281,   1221.665,   1222.049,   1222.434,   1222.818,   1223.202,   1223.586,   1223.970,   1224.350},
    /*58*/ {1224.739,   1225.123,   1225.507,   1225.891,   1226.275,   1226.659,   1227.043,   1227.427,   1227.811,   1228.195},
    /*59*/ {1228.579,   1228.963,   1229.347,   1229.731,   1230.115,   1230.499,   1230.883,   1231.267,   1231.651,   1232.030},
    /*60*/ {1232.419,   1232.803,   1233.187,   1233.571,   1233.955,   1234.338,   1234.722,   1235.106,   1235.490,   1235.870},
    /*61*/ {1236.257,   1236.641,   1237.025,   1237.409,   1237.792,   1238.176,   1238.560,   1238.944,   1239.327,   1239.711},
    /*62*/ {1240.095,   1240.478,   1240.862,   1241.246,   1241.629,   1242.030,   1242.396,   1242.780,   1243.164,   1243.500},
    /*63*/ {1243.931,   1244.314,   1244.698,   1245.081,   1245.465,   1245.848,   1246.230,   1246.615,   1246.999,   1247.382},
    /*64*/ {1247.766,   1248.149,   1248.533,   1248.916,   1249.299,   1249.683,   1250.066,   1250.450,   1250.833,   1251.210},
    /*65*/ {1251.600,   1251.983,   1252.366,   1252.749,   1253.133,   1253.516,   1253.899,   1254.283,   1254.666,   1255.040},
    /*66*/ {1255.432,   1255.815,   1256.199,   1256.582,   1256.965,   1257.348,   1257.731,   1258.114,   1258.497,   1258.880},
    /*67*/ {1259.264,   1259.647,   1260.030,   1260.413,   1260.796,   1261.179,   1261.562,   1261.945,   1262.328,   1262.710},
    /*68*/ {1263.094,   1263.477,   1263.860,   1264.243,   1264.626,   1265.009,   1265.392,   1265.775,   1266.157,   1266.540},
    /*69*/ {1266.923,   1267.306,   1267.689,   1268.072,   1268.455,   1268.837,   1269.220,   1269.603,   1269.986,   1270.360},
    /*70*/ {1270.751,   1271.134,   1271.517,   1271.899,   1272.282,   1272.665,   1273.048,   1273.430,   1273.813,   1274.190},
    /*71*/ {1274.578,   1274.691,   1274.803,   1274.916,   1275.029,   1275.141,   1275.254,   1275.366,   1275.479,   1275.591},
    /*72*/ {1278.404,   1278.786,   1279.169,   1279.551,   1279.934,   1280.316,   1280.699,   1281.081,   1281.464,   1281.846},
    /*73*/ {1282.228,   1282.611,   1282.993,   1283.376,   1283.758,   1284.140,   1284.523,   1284.905,   1285.287,   1285.670},
    /*74*/ {1286.052,   1286.434,   1286.816,   1287.199,   1287.581,   1287.963,   1288.345,   1288.728,   1289.110,   1289.492},
    /*75*/ {1289.874,   1290.256,   1290.638,   1291.021,   1291.403,   1291.785,   1292.167,   1292.549,   1292.931,   1293.313},
    /*76*/ {1293.695,   1294.077,   1294.459,   1294.841,   1295.223,   1295.605,   1295.980,   1296.369,   1296.751,   1297.130},
    /*77*/ {1297.515,   1297.897,   1298.279,   1298.661,   1299.043,   1299.425,   1299.807,   1300.188,   1300.570,   1300.952},
    /*78*/ {1301.334,   1301.716,   1302.098,   1302.479,   1302.861,   1303.243,   1303.625,   1304.006,   1304.388,   1304.770},
    /*79*/ {1305.152,   1305.533,   1305.915,   1306.297,   1306.678,   1307.060,   1307.442,   1307.823,   1308.205,   1308.586},
    /*80*/ {1308.968,   1309.350,   1309.731,   1310.113,   1310.494,   1310.876,   1311.270,   1311.639,   1312.020,   1312.402},
    /*81*/ {1312.783,   1313.165,   1313.546,   1313.928,   1314.309,   1314.691,   1315.072,   1315.453,   1315.835,   1316.216},
    /*82*/ {1316.597,   1316.979,   1317.360,   1317.742,   1318.123,   1318.504,   1318.885,   1319.267,   1319.648,   1320.029},
    /*83*/ {1320.411,   1320.792,   1321.173,   1321.554,   1321.935,   1322.316,   1322.697,   1323.079,   1323.460,   1323.841},
    /*84*/ {1324.222,   1324.603,   1324.985,   1325.366,   1325.747,   1326.128,   1326.509,   1326.890,   1327.271,   1327.652},
    /*85*/ {1328.033,   1328.414,   1328.795,   1329.176,   1329.557,   1329.938,   1330.319,   1330.700,   1331.081,   1331.460},
    /*86*/ {1331.843,   1332.224,   1332.604,   1332.985,   1333.366,   1333.747,   1334.128,   1334.509,   1334.889,   1335.270},
    /*87*/ {1335.651,   1336.032,   1336.413,   1336.793,   1337.174,   1337.555,   1337.935,   1338.316,   1338.697,   1339.070},
    /*88*/ {1339.458,   1335.839,   1332.220,   1328.600,   1324.981,   1321.361,   1317.742,   1314.123,   1310.503,   1306.884},
    /*89*/ {1343.264,   1343.645,   1344.025,   1344.406,   1344.786,   1345.167,   1345.570,   1345.928,   1346.308,   1346.689},
    /*90*/ {1347.069,   1347.450,   1347.830,   1348.211,   1348.591,   1348.971,   1349.352,   1349.732,   1350.112,   1350.493},
    /*91*/ {1350.873,   1351.253,   1351.634,   1352.014,   1352.394,   1352.774,   1353.155,   1353.535,   1353.915,   1354.295},
    /*92*/ {1354.676,   1355.056,   1355.436,   1355.816,   1356.196,   1356.577,   1356.957,   1357.337,   1357.717,   1358.097},
    /*93*/ {1358.477,   1358.857,   1359.237,   1359.617,   1359.997,   1360.377,   1360.757,   1361.137,   1361.517,   1361.897},
    /*94*/ {1362.277,   1362.657,   1363.037,   1363.417,   1363.797,   1364.177,   1364.557,   1364.937,   1365.317,   1365.690},
    /*95*/ {1366.077,   1366.456,   1366.836,   1367.216,   1367.596,   1367.976,   1368.355,   1368.735,   1369.115,   1369.495},
    /*96*/ {1369.875,   1370.254,   1370.634,   1371.014,   1371.393,   1371.773,   1372.153,   1372.532,   1372.912,   1373.290},
    /*97*/ {1373.671,   1374.051,   1374.431,   1374.810,   1375.190,   1375.569,   1375.949,   1376.329,   1376.708,   1377.088},
    /*98*/ {1377.467,   1377.847,   1378.226,   1378.606,   1378.985,   1379.365,   1379.744,   1380.123,   1380.503,   1380.882},
    /*99*/ {1381.262,   1381.641,   1382.020,   1382.400,   1382.779,   1383.158,   1383.538,   1383.917,   1384.296,   1384.676}
};

extern rt_err_t hm_print(struct hm_print_data* pd);
rt_inline void heat_print(rt_uint32_t heat)
{
    static struct hm_print_data pd;
    static char buf[10];
    rt_sprintf(buf, "%d", heat);
    pd.x = 36;
    pd.y = 7;
    pd.str = buf;
    hm_print(&pd);
}
rt_inline void tof_print(float speed)
{
    static struct hm_print_data pd;
    static char buf[10];
    sprintf(buf, "%.1f", speed);
    pd.x = 36;
    pd.y = 12;
    pd.str = buf;
    hm_print(&pd);
}

rt_inline void temp_print(float hot, float cold)
{
#define   HOT    (0)
#define   COLD   (1)
    static struct hm_print_data pd[2];
    static char buf[2][10];
    sprintf(buf[HOT], "%.1f", hot);
    pd[HOT].x = 36;
    pd[HOT].y = 2;
    pd[HOT].str = buf[HOT];
    hm_print(&pd[HOT]);
    sprintf(buf[COLD], "%.1f", cold);
    pd[COLD].x = 115;
    pd[COLD].y = 2;
    pd[COLD].str = buf[COLD];
    hm_print(&pd[COLD]);
}

void hm_tof_thread_entry(void* parameter)
{
    rt_device_t tdc = RT_NULL;
    rt_uint8_t tof_data_count = 0;

    tdc = rt_device_find(HM_BOARD_TDC_NAME);
    RT_ASSERT(tdc);
    rt_device_open(tdc, RT_DEVICE_OFLAG_RDWR);
    tof_lock = rt_mutex_create("L_tof", RT_IPC_FLAG_FIFO);
    RT_ASSERT(tof_lock);
    if(tdc_lock == RT_NULL) {
        tdc_lock = rt_mutex_create("L_tdc", RT_IPC_FLAG_FIFO);
        RT_ASSERT(tdc_lock);
    }

    while(1) {
        if(rt_mutex_take(tdc_lock, RT_WAITING_FOREVER) != RT_EOK) {
            rt_kprintf("TOF take tdc lock error\n");
        }
        else {
            rt_kprintf("TOF take tdc lock\n");
            if(rt_mutex_take(tof_lock, MS_TO_TICKS(LOCK_TACK_WAIT_TIME_MS)) != RT_EOK) {
                rt_kprintf("TOF take lock error\n");
                rt_mutex_release(tdc_lock);
                continue;
            }
            else {
                rt_device_control(tdc, SPI_TDC_GP21_CTRL_MEASURE_TOF2, tof_data+tof_data_count);
                rt_mutex_release(tof_lock);
                rt_mutex_release(tdc_lock);
                rt_kprintf("TOF release tdc lock\n");
                tof_data_count++;
                if(tof_data_count==TOF_DATA_BUF_LEN) {
                    tof_data_count = 0;
                    if(rt_event_send(cal_event, TOF_DATA_FULL_EVENT) != RT_EOK) {
                        rt_kprintf("TOF send event error\n");
                    }
                }
            }
        }
        rt_thread_delay(MS_TO_TICKS(TOF_SLEEP_TIME_MS));
    }
}

void hm_temp_thread_entry(void* parameter)
{
    rt_device_t tdc = RT_NULL;
    rt_uint8_t temp_data_count = 0;

    tdc = rt_device_find(HM_BOARD_TDC_NAME);
    RT_ASSERT(tdc);
    rt_device_open(tdc, RT_DEVICE_OFLAG_RDWR);
    temp_lock = rt_mutex_create("L_temp", RT_IPC_FLAG_FIFO);
    RT_ASSERT(temp_lock);
    if(tdc_lock == RT_NULL) {
        tdc_lock = rt_mutex_create("L_tdc", RT_IPC_FLAG_FIFO);
        RT_ASSERT(tdc_lock);
    }

    while(1) {
        if(rt_mutex_take(tdc_lock, RT_WAITING_FOREVER) != RT_EOK) {
            rt_kprintf("temprature take tdc lock error\n");
        }
        else {
            rt_kprintf("temprature take tdc lock\n");
            if(rt_mutex_take(temp_lock, MS_TO_TICKS(LOCK_TACK_WAIT_TIME_MS)) != RT_EOK) {
                rt_kprintf("temprature take lock error\n");
                rt_mutex_release(tdc_lock);
                continue;
            }
            else {
                rt_device_control(tdc, SPI_TDC_GP21_CTRL_MEASURE_TEMP, temp_data+temp_data_count);
                rt_mutex_release(temp_lock);
                rt_mutex_release(tdc_lock);
                rt_kprintf("temprature release tdc lock\n");
                temp_data_count++;
                if(temp_data_count==TEMP_DATA_BUF_LEN) {
                    temp_data_count = 0;
                    if(rt_event_send(cal_event, TEMP_DATA_FULL_EVENT) != RT_EOK) {
                        rt_kprintf("temprature send event error\n");
                    }
                }
            }
        }
        rt_thread_delay(MS_TO_TICKS(TEMP_SLEEP_TIME_MS));
    }
}

static int bi_search_coarse(float res)
{
    int mid = 0;
    int begin = 0;
    int end = sizeof(PT1000)/sizeof(PT1000[0]);

    const float (*ptr)[sizeof(PT1000[0])/sizeof(PT1000[0][0])];
    ptr = PT1000;

    while(begin <= end) {
        mid = (begin+end)/2;
        if(res > ptr[mid][0]) {
            begin = mid + 1;
        }
        else if(res < ptr[mid][0]) {
            end = mid - 1;
        }
        else {
            return mid;
        }
    }
    return end;
}

static int bi_search_fine(float res, int coarse)
{
    int mid = 0;
    int begin = 0;
    int end = sizeof(PT1000[0])/sizeof(PT1000[0][0]);

    const float* ptr = PT1000[coarse];

    while(begin <= end) {
        mid = (begin+end)/2;
        if(res > ptr[mid]) {
            begin = mid + 1;
        }
        else if(res < ptr[mid]) {
            end = mid - 1;
        }
        else {
            return mid;
        }
    }
    return end;
}

static float temp_cal(const float temp_scale)
{
    float res = temp_scale*1000;

    int coarse = bi_search_coarse(res);
    int fine = bi_search_fine(res, coarse);

    return (1.0*(coarse+PT1000_MIN_TEMP+1)+0.1*fine);
}

static float get_average(float* ptr, int n)
{
    float ave = *ptr;
    int i = 0;

    if(n<=0) {
        return 0;
    }

    for(i=1; i<n; i++) {
        ave = ave*((float)i/(float)(i+1)) + *++ptr/((float)(i+1));
    }
    return ave;
}

static rt_uint32_t do_heat_cal(void)
{
    float hot[TEMP_DATA_BUF_LEN];
    float cold[TEMP_DATA_BUF_LEN];
    float hot_avr = 0;
    float cold_avr = 0;
    int i = 0;

    for(i=0; i<TEMP_DATA_BUF_LEN; i++) {
        hot[i] = temp_cal(temp_data[i].hot);
        cold[i] = temp_cal(temp_data[i].cold);
    }
#if 1
    hot_avr = get_average(hot, TEMP_DATA_BUF_LEN);
    cold_avr = get_average(cold, TEMP_DATA_BUF_LEN);
    temp_print(hot_avr, cold_avr);
#endif

    return 0;
}

void hm_heatcal_thread_entry(void* parameter)
{
    rt_uint32_t event_set = 0;
    rt_uint32_t heat_used = 0;
    cal_event = rt_event_create("H_cal", RT_IPC_FLAG_FIFO);
    RT_ASSERT(cal_event);

    while(1) {
        if(rt_event_recv(cal_event, TOF_DATA_FULL_EVENT | TEMP_DATA_FULL_EVENT,
                         RT_EVENT_FLAG_AND | RT_EVENT_FLAG_CLEAR, RT_WAITING_FOREVER,
                         &event_set)==RT_EOK) {
            if((rt_mutex_take(temp_lock, MS_TO_TICKS(LOCK_TACK_WAIT_TIME_MS)) ||
                (rt_mutex_take(tof_lock, MS_TO_TICKS(LOCK_TACK_WAIT_TIME_MS)))) != RT_EOK) {
                rt_kprintf("TOF and temprature take lock error\n");
            }
            heat_used += do_heat_cal();
            rt_mutex_release(tof_lock);
            rt_mutex_release(temp_lock);
            heat_print(heat_used);
        }
    }
}
